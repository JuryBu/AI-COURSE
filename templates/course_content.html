{% extends "base.html" %}

{% block title %}课程内容{% endblock %}
{% block page_title %}课程内容{% endblock %}

{% block content %}
<h2>已上传资源</h2>

<div class="menu">
    <a href="{{ url_for('upload_file') }}" class="btn-upload">上传资源</a>
</div>

<div class="chapters">
    {% for chapter_name, sections in chapters.items() %}
    <details class="chapter">
        <summary>
            <h3>{{ chapter_name }}</h3>
        </summary>
        <div class="sections">
            {% for section_name, section_data in sections.items() %}
            <details class="section">
                <summary>
                    <h4>{{ section_name }}</h4>
                </summary>
                {# 视频部分 #}
                {% if section_data.videos %}
                <div class="resource-category">
                    <ul>
                        {% for file in section_data.videos %}
                        <li>
                            <div class="video-resource">
                                <h6>{{ file|replace('.mp4', '') }}</h6>
                                <video width="500" controls>
                                    <source src="{{ url_for('serve_video', filename=chapter_name + '/' + section_name + '/videos/' + file) }}" type="video/mp4">
                                    您的浏览器不支持视频标签。
                                </video>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% set j = 0 %}

                <div class="classroom-exercises">
                    <h6>课堂练习</h6>
                    {% if section_data.classroom_exercises %}
                    <ul>
                        {% for file in section_data.classroom_exercises %}
                        <li>
                            {% set index = loop.index %}
                            <strong>题目 {{ index }}:</strong><br>
                            {% set ques = read_ques(chapter_name, section_name, 'classroom_exercises', index) %}
                            {% if ques %}
                            {% if ques.image %}
                                <img src="{{ url_for('static', filename=chapter_name + '/' + section_name + '/classroom_exercises/' + ques.image) }}" alt="习题图片" width="500"><br>
                            {% endif %}
                            {% if ques.text %}
                                {{ ques.text }}<br>
                            {% endif %}
                            {% else %}
                            <p>暂未设置题目</p>
                            {% endif %}

                            <button class="btn-action" onclick="toggleAnswer('{{ chapter_name }}', '{{ section_name }}', {{ index }}, {{ j }})">参考答案</button>

                            <div class="answer" id="answer-{{ chapter_name }}-{{ section_name }}-{{ index }}-{{ j }}" style="display:none;">
                                {% set answer = read_answer(chapter_name, section_name, index) %}
                                {% if answer %}
                                <strong>题目{{ index }}答案:</strong><br>
                                {% if answer['image'] %}
                                <img src="{{ url_for('static', filename=chapter_name + '/' + section_name + '/answers/' + answer['image']) }}" alt="参考答案图片" width="400">
                                {% endif %}
                                {% if answer['text'] %}
                                <p>{{ answer['text'] }}</p>
                                {% endif %}
                                {% else %}
                                <strong>本题暂未设置答案<strong><br>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>本节暂未设置课堂练习</p>
                    {% endif %}
                </div>

                {% set count = section_data.classroom_exercises|length %}
                {% set j = j + count %}

                <div class="homework">
                    <h6>课后习题</h6>
                    {% if section_data.homework %}
                    <ul>
                        {% for file in section_data.homework %}
                        <li>
                            {% set index = loop.index %}
                            <strong>题目 {{ index }}:</strong><br>
                            {% set ques = read_ques(chapter_name, section_name, 'homework', index) %}
                            {% if ques %}
                            {% if ques.image %}
                                <img src="{{ url_for('static', filename=chapter_name + '/' + section_name + '/homework/' + ques.image) }}" alt="习题图片" width="500"><br>
                            {% endif %}
                            {% if ques.text %}
                                {{ ques.text }}<br>
                            {% endif %}
                            {% else %}
                            <p>暂未设置题目</p>
                            {% endif %}

                            <button class="btn-action" onclick="toggleAnswer('{{ chapter_name }}', '{{ section_name }}', {{ index }}, {{ j }})">参考答案</button>

                            <div class="answer" id="answer-{{ chapter_name }}-{{ section_name }}-{{ index }}-{{ j }}" style="display:none;">
                                {% set answer = read_answer(chapter_name, section_name, index + j) %}
                                {% if answer %}
                                <strong>题目{{ index }}答案:</strong><br>
                                {% if answer['image'] %}
                                <img src="{{ url_for('static', filename=chapter_name + '/' + section_name + '/answers/' + answer['image']) }}" alt="参考答案图片" width="400">
                                {% endif %}
                                {% if answer['text'] %}
                                <p>{{ answer['text'] }}</p>
                                {% endif %}
                                {% else %}
                                <strong>本题暂未设置答案<strong><br>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>本节暂未设置课后习题</p>
                    {% endif %}
                </div>

                <div class="discussion-exercises">
                    <h6>讨论区习题</h6>
                    {% if section_data.discussion_exercises %}
                    <ul>
                        {% for file in section_data.discussion_exercises %}
                        <li>
                            {% set index = loop.index %}
                            <strong>题目 {{ index }}:</strong><br>
                            {% set ques = read_ques(chapter_name, section_name, 'discussion_exercises', index) %}
                            {% if ques %}
                            {% if ques.image %}
                                <img src="{{ url_for('static', filename=chapter_name + '/' + section_name + '/discussion_exercises/' + ques.image) }}" alt="习题图片" width="500"><br>
                            {% endif %}
                            {% if ques.text %}
                                {{ ques.text }}<br>
                            {% endif %}
                            {% else %}
                            <p>暂未设置题目</p>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>本节暂未设置讨论区习题</p>
                    {% endif %}
                </div>

                <div class="discussion">
                    <h6>讨论区</h6>
                    <form method="POST" action="{{ url_for('submit_discussion', chapter_name=chapter_name, section_name=section_name) }}">
                        <textarea name="discussion_content" rows="4" cols="50" placeholder="请输入讨论内容..."></textarea><br>
                        <button type="submit" class="btn-action">提交讨论</button>
                    </form>

                    {% if discussions[section_name] %}
                    <div class="discussion-content">
                        <h4>已有讨论：</h4>
                        <ul>
                            {% for discussion in discussions[section_name] %}
                            <li>
                                <strong class="discussion-index">{{ loop.index }}. </strong>
                                <span class="discussion-text">{{ discussion }}</span>
                                <hr>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% else %}
                    <p>暂无讨论</p>
                    {% endif %}
                </div>

                <!--AI 聊天助手 -->
                <div class="chat-wrapper" id="chatWrapper">
                    <!-- 【修复】为header添加id，并移除onclick -->
                    <div class="chat-header" id="chatHeader">
                        <span>在线AI小助手</span>
                        <button class="chat-toggle">▼</button>
                    </div>

                    <div class="chat-container" id="chatContainer"></div>

                    <div class="input-container" id="chatControls">
                        <div class="input-box">
                            <textarea id="userInput" placeholder="输入您的问题..." rows="2"></textarea>
                            <div class="chat-controls">
                                <!-- 【修复】移除所有按钮的onclick属性，并为导出和清空按钮添加ID -->
                                <button id="sendButton">发送</button>
                                <button id="exportButton">导出</button>
                                <button id="clearButton">清空</button>
                                <button id="stopButton" disabled>中断</button>
                            </div>
                        </div>
                    </div>
                    <div class="chat-footer">
                       使用模型 deepseek-math-7b，AI 生成内容仅供参考，不绝对正确。
                    </div>
                </div>
            </details>
            {% endfor %}
        </div>
    </details>
    {% endfor %}
</div>

<div class="menu">
    <a href="{{ url_for('index') }}">返回首页</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // 这个函数由Jinja循环生成，数量不确定，保留在全局作用域是最简单的处理方式
    function toggleAnswer(chapter, section, questionIndex, index) {
        var answerDiv = document.getElementById('answer-' + chapter + '-' + section + '-' + questionIndex + '-' + index);
        if (answerDiv.style.display === "none") {
            answerDiv.style.display = "block";
        } else {
            answerDiv.style.display = "none";
        }
    }
    window.toggleAnswer = toggleAnswer;


    // --- 聊天窗口拖动逻辑 ---
    const dragElement = document.getElementById("chatWrapper");
    const header = document.getElementById("chatHeader"); // 使用ID获取
    let offsetX = 0, offsetY = 0, isDragging = false;

    header.addEventListener("mousedown", (e) => {
        // 防止点击按钮时也触发拖动
        if (e.target.tagName === 'BUTTON') return;
        isDragging = true;
        offsetX = e.clientX - dragElement.getBoundingClientRect().left;
        offsetY = e.clientY - dragElement.getBoundingClientRect().top;
        document.body.style.userSelect = 'none';
    });

    document.addEventListener("mousemove", (e) => {
        if (isDragging) {
            dragElement.style.left = `${e.clientX - offsetX}px`;
            dragElement.style.top = `${e.clientY - offsetY}px`;
            dragElement.style.right = "auto";
            dragElement.style.bottom = "auto";
        }
    });

    document.addEventListener("mouseup", () => {
        if (isDragging) {
            isDragging = false;
            document.body.style.userSelect = '';
        }
    });

    // --- AI聊天核心逻辑 ---
    let currentStreamController = null;
    let isGenerating = false;
    let chatHistory = [];

    // 【修复】获取所有交互元素，并用 addEventListener 绑定事件
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const stopButton = document.getElementById('stopButton');
    const exportButton = document.getElementById('exportButton');
    const clearButton = document.getElementById('clearButton');
    const chatContainer = document.getElementById('chatContainer');

    sendButton.addEventListener('click', sendRequest);
    stopButton.addEventListener('click', stopGeneration);
    exportButton.addEventListener('click', exportHistory);
    clearButton.addEventListener('click', clearHistory);
    header.addEventListener('click', toggleChat);
    userInput.addEventListener('input', autoResize);
    userInput.addEventListener('keydown', handleKeyDown);

    // 初始化
    loadHistory();
    renderHistory();

    function autoResize() {
        userInput.style.height = 'auto';
        userInput.style.height = userInput.scrollHeight + 'px';
    }

    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // 阻止默认的回车换行行为
            sendRequest();
        }
    }

    function stopGeneration() {
        if (currentStreamController) {
            currentStreamController.abort();
            console.log("用户中断了生成");
        }
        // 注意：addMessage 和 disableInput 会在 sendRequest 的 finally 块中处理
    }

    async function sendRequest() {
        const message = userInput.value.trim();
        if (!message || isGenerating) return;

        addMessageToHistory({ role: 'user', content: message });
        renderHistory(); // 重新渲染以显示用户消息
        userInput.value = '';
        autoResize();

        try {
            currentStreamController = new AbortController();
            isGenerating = true;
            disableInput(true);

            // 为AI响应创建并添加一个空的容器
            const botMessageBubble = addMessage("", false); // 添加一个空的机器人消息气泡
            let fullResponse = '';

            const response = await fetch("/receive", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "deepseek-math-7b-instruct",
                    messages: chatHistory,
                    stream: true,
                    temperature: 0.7
                }),
                signal: currentStreamController.signal
            });

            if (!response.ok) {
                throw new Error(`网络响应错误: ${response.status} ${response.statusText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonString = line.substring(6);
                        if (jsonString === '[DONE]') continue;
                        try {
                            const data = JSON.parse(jsonString);
                            const delta = data.choices[0]?.delta?.content || '';
                            fullResponse += delta;
                            botMessageBubble.innerHTML = marked.parse(fullResponse); // 持续更新同一个气泡
                            scrollToBottom();
                        } catch (e) {
                            console.error('解析流式数据错误:', e, '原始数据:', line);
                        }
                    }
                }
            }

            // 流结束后更新历史记录
            addMessageToHistory({ role: 'assistant', content: fullResponse });
            saveHistory();

            // 如果使用了MathJax，在这里对最终结果进行渲染
            if (window.MathJax) {
                MathJax.typesetPromise([botMessageBubble]).catch(err => console.error('MathJax渲染错误:', err));
            }

        } catch (error) {
            if (error.name === 'AbortError') {
                addMessage("生成已中断。", false);
            } else {
                console.error('请求失败:', error);
                addMessage(`请求失败: ${error.message}`, false);
            }
        } finally {
            isGenerating = false;
            disableInput(false);
            currentStreamController = null;
        }
    }

    function disableInput(disabled) {
        userInput.disabled = disabled;
        sendButton.disabled = disabled;
        stopButton.disabled = !disabled;
        if (!disabled) userInput.focus();
    }

    function addMessageToHistory(message) {
        // 如果最后一条消息是助手消息，则替换它（用于流式传输结束时更新），否则添加新消息
        const lastMessage = chatHistory[chatHistory.length - 1];
        if (lastMessage && lastMessage.role === 'assistant' && message.role === 'assistant') {
            lastMessage.content = message.content;
        } else {
            chatHistory.push(message);
        }
        if (chatHistory.length > 50) chatHistory.shift(); // 保持历史记录长度
    }

    function saveHistory() {
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    }

    function loadHistory() {
        const saved = localStorage.getItem('chatHistory');
        if (saved) {
            chatHistory = JSON.parse(saved);
        }
    }

    function clearHistory() {
        chatHistory = [];
        localStorage.removeItem('chatHistory');
        renderHistory();
    }

    function exportHistory() {
        const blob = new Blob([JSON.stringify(chatHistory, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat_history_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function renderHistory() {
        chatContainer.innerHTML = '';
        chatHistory.forEach(msg => {
            addMessage(msg.content, msg.role === 'user');
        });
        if (window.MathJax) {
            MathJax.typesetPromise(Array.from(chatContainer.children)).catch(err => console.error("历史记录渲染错误:", err));
        }
    }

    function addMessage(content, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.innerHTML = marked.parse(content || "..."); // 显示...以表示正在加载

        messageDiv.appendChild(bubble);
        chatContainer.appendChild(messageDiv);
        scrollToBottom();
        return bubble; // 返回气泡元素以便后续更新
    }

    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function toggleChat(event) {
        // 防止点击header里的按钮也触发折叠
        if (event && event.target.tagName === 'BUTTON') return;

        const wrapper = document.getElementById("chatWrapper");
        const toggleBtn = wrapper.querySelector(".chat-toggle");
        const footer = wrapper.querySelector(".chat-footer");

        wrapper.classList.toggle("collapsed");
        if (wrapper.classList.contains("collapsed")) {
            toggleBtn.textContent = "▲";
            footer.style.display = "none";
        } else {
            toggleBtn.textContent = "▼";
            footer.style.display = "block";
        }
    }
});
</script>
{% endblock %}