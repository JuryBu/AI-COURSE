{% extends "base.html" %}

{% block title %}课程内容{% endblock %}
{% block page_title %}课程内容{% endblock %}

{% block content %}
<h2>已上传资源</h2>

<div class="menu">
    <a href="{{ url_for('upload_file') }}" class="btn-upload">上传资源</a>
</div>

<div class="chapters">
    {% for chapter_name, sections in chapters.items() %}
    <details class="chapter">
        <summary>
            <h3>{{ chapter_name }}</h3>
        </summary>
        <div class="sections">
            {% for section_name, section_data in sections.items() %}
            <details class="section">
                <summary>
                    <h4>{{ section_name }}</h4>
                </summary>
                {# 视频部分 #}
                {% if section_data.videos %}
                <div class="resource-category">
                    <ul>
                        {% for file in section_data.videos %}
                        <li>
                            <div class="video-resource">
                                <h6>{{ file|replace('.mp4', '') }}</h6>
                                <video width="500" controls>
                                    <source src="{{ url_for('serve_video', filename=chapter_name + '/' + section_name + '/videos/' + file) }}" type="video/mp4">
                                    您的浏览器不支持视频标签。
                                </video>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% set j = 0 %}

                <div class="classroom-exercises">
                    <h6>课堂练习</h6>
                    {% if section_data.classroom_exercises %}
                    <ul>
                        {% for file in section_data.classroom_exercises %}
                        <li>
                            {% set index = loop.index %}
                            <strong>题目 {{ index }}:</strong><br>
                            {% set ques = read_ques(chapter_name, section_name, 'classroom_exercises', index) %}
                            {% if ques %}
                            {% if ques.image %}
                                <img src="{{ url_for('static', filename=chapter_name + '/' + section_name + '/classroom_exercises/' + ques.image) }}" alt="习题图片" width="500"><br>
                            {% endif %}
                            {% if ques.text %}
                                {{ ques.text }}<br>
                            {% endif %}
                            {% else %}
                            <p>暂未设置题目</p>
                            {% endif %}

                            <button class="btn-action" onclick="toggleAnswer('{{ chapter_name }}', '{{ section_name }}', {{ index }}, {{ j }})">参考答案</button>

                            <div class="answer" id="answer-{{ chapter_name }}-{{ section_name }}-{{ index }}-{{ j }}" style="display:none;">
                                {% set answer = read_answer(chapter_name, section_name, index) %}
                                {% if answer %}
                                <strong>题目{{ index }}答案:</strong><br>
                                {% if answer['image'] %}
                                <img src="{{ url_for('static', filename=chapter_name + '/' + section_name + '/answers/' + answer['image']) }}" alt="参考答案图片" width="400">
                                {% endif %}
                                {% if answer['text'] %}
                                <p>{{ answer['text'] }}</p>
                                {% endif %}
                                {% else %}
                                <strong>本题暂未设置答案<strong><br>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>本节暂未设置课堂练习</p>
                    {% endif %}
                </div>

                {% set count = section_data.classroom_exercises|length %}
                {% set j = j + count %}

                <div class="homework">
                    <h6>课后习题</h6>
                    {% if section_data.homework %}
                    <ul>
                        {% for file in section_data.homework %}
                        <li>
                            {% set index = loop.index %}
                            <strong>题目 {{ index }}:</strong><br>
                            {% set ques = read_ques(chapter_name, section_name, 'homework', index) %}
                            {% if ques %}
                            {% if ques.image %}
                                <img src="{{ url_for('static', filename=chapter_name + '/' + section_name + '/homework/' + ques.image) }}" alt="习题图片" width="500"><br>
                            {% endif %}
                            {% if ques.text %}
                                {{ ques.text }}<br>
                            {% endif %}
                            {% else %}
                            <p>暂未设置题目</p>
                            {% endif %}

                            <button class="btn-action" onclick="toggleAnswer('{{ chapter_name }}', '{{ section_name }}', {{ index }}, {{ j }})">参考答案</button>

                            <div class="answer" id="answer-{{ chapter_name }}-{{ section_name }}-{{ index }}-{{ j }}" style="display:none;">
                                {% set answer = read_answer(chapter_name, section_name, index + j) %}
                                {% if answer %}
                                <strong>题目{{ index }}答案:</strong><br>
                                {% if answer['image'] %}
                                <img src="{{ url_for('static', filename=chapter_name + '/' + section_name + '/answers/' + answer['image']) }}" alt="参考答案图片" width="400">
                                {% endif %}
                                {% if answer['text'] %}
                                <p>{{ answer['text'] }}</p>
                                {% endif %}
                                {% else %}
                                <strong>本题暂未设置答案<strong><br>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>本节暂未设置课后习题</p>
                    {% endif %}
                </div>

                <div class="discussion-exercises">
                    <h6>讨论区习题</h6>
                    {% if section_data.discussion_exercises %}
                    <ul>
                        {% for file in section_data.discussion_exercises %}
                        <li>
                            {% set index = loop.index %}
                            <strong>题目 {{ index }}:</strong><br>
                            {% set ques = read_ques(chapter_name, section_name, 'discussion_exercises', index) %}
                            {% if ques %}
                            {% if ques.image %}
                                <img src="{{ url_for('static', filename=chapter_name + '/' + section_name + '/discussion_exercises/' + ques.image) }}" alt="习题图片" width="500"><br>
                            {% endif %}
                            {% if ques.text %}
                                {{ ques.text }}<br>
                            {% endif %}
                            {% else %}
                            <p>暂未设置题目</p>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>本节暂未设置讨论区习题</p>
                    {% endif %}
                </div>

                <div class="discussion">
                    <h6>讨论区</h6>
                    <form method="POST" action="{{ url_for('submit_discussion', chapter_name=chapter_name, section_name=section_name) }}">
                        <textarea name="discussion_content" rows="4" cols="50" placeholder="请输入讨论内容..."></textarea><br>
                        <button type="submit" class="btn-action">提交讨论</button>
                    </form>

                    {% if discussions[section_name] %}
                    <div class="discussion-content">
                        <h4>已有讨论：</h4>
                        <ul>
                            {% for discussion in discussions[section_name] %}
                            <li>
                                <strong class="discussion-index">{{ loop.index }}. </strong>
                                <span class="discussion-text">{{ discussion }}</span>
                                <hr>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% else %}
                    <p>暂无讨论</p>
                    {% endif %}
                </div>

                <!--AI 聊天助手 -->
                <div class="chat-wrapper" id="chatWrapper">
                    <div class="chat-header" onclick="toggleChat()">
                        <span>在线AI小助手</span>
                        <button class="chat-toggle">▼</button>
                    </div>

                    <div class="chat-container" id="chatContainer"></div>

                    <div class="input-container" id="chatControls">
                        <div class="input-box">
                            <textarea id="userInput" placeholder="输入您的问题..." rows="2"></textarea>
                            <div class="chat-controls">
                                <button id="sendButton" onclick="sendRequest()">发送</button>
                                <button onclick="exportHistory()">导出</button>
                                <button onclick="clearHistory()">清空</button>
                                <button id="stopButton" onclick="stopGeneration()" disabled>中断</button>
                            </div>
                        </div>
                    </div>
                    <div class="chat-footer">
                       使用模型 deepseek-math-7b，AI 生成内容仅供参考，不绝对正确。
                    </div>
                </div>
            </details>
            {% endfor %}
        </div>
    </details>
    {% endfor %}
</div>

<div class="menu">
    <a href="{{ url_for('index') }}">返回首页</a>
</div>

<script>
// 【关键修复】确保所有JS代码在DOM加载完成后执行
document.addEventListener('DOMContentLoaded', function() {

    // 这个函数不需要等待DOM，但放在这里完全没问题
    function toggleAnswer(chapter, section, questionIndex, index, type = '') {
        var answerDiv = document.getElementById('answer-' + chapter + '-' + section + (type ? '-' + type : '') + '-' + questionIndex + '-' + index);
        if (answerDiv.style.display === "none") {
            answerDiv.style.display = "block";
        } else {
            answerDiv.style.display = "none";
        }
    }

    // --- 聊天窗口拖动逻辑 ---
    let dragElement = document.getElementById("chatWrapper");
    let header = dragElement.querySelector(".chat-header");
    let offsetX = 0, offsetY = 0, isDragging = false;

    header.addEventListener("mousedown", (e) => {
        isDragging = true;
        offsetX = e.clientX - dragElement.getBoundingClientRect().left;
        offsetY = e.clientY - dragElement.getBoundingClientRect().top;
        document.body.style.userSelect = 'none';
    });

    document.addEventListener("mousemove", (e) => {
        if (isDragging) {
            dragElement.style.left = `${e.clientX - offsetX}px`;
            dragElement.style.top = `${e.clientY - offsetY}px`;
            dragElement.style.right = "auto";
            dragElement.style.bottom = "auto";
        }
    });

    document.addEventListener("mouseup", () => {
        isDragging = false;
        document.body.style.userSelect = '';
    });

    // --- AI聊天核心逻辑 ---
    let currentStreamController = null;
    let isGenerating = false;
    let chatHistory = [];

    // 初始化：现在可以安全地访问DOM了
    loadHistory();
    renderHistory();

    const textarea = document.getElementById('userInput');
    textarea.addEventListener('input', autoResize);
    textarea.addEventListener('keydown', handleKeyDown); // 绑定回车发送事件

    function autoResize() {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendRequest();
        }
    }

    window.stopGeneration = function() { // 暴露到全局，让onclick可以调用
        if (currentStreamController) {
            currentStreamController.abort();
            addMessage("生成已中断", false);
            console.log("用户中断了生成");
        }
        disableInput(false);
    }

    window.sendRequest = async function() { // 暴露到全局
        const userInput = document.getElementById('userInput');
        const message = userInput.value.trim();
        if (!message) return;

        try {
            currentStreamController = new AbortController();
            isGenerating = true;
            disableInput(true);

            userInput.value = '';
            autoResize();

            addMessageToHistory({ role: 'user', content: message });
            addMessage(message, true);

            const thinkingContainer = createThinkingContainer();
            const answerContainer = createAnswerContainer();
            let isThinking = false;
            let fullResponse = '';

            const response = await fetch("/receive", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "deepseek-math-7b-instruct",
                    messages: chatHistory,
                    stream: true,
                    temperature: 0.7
                }),
                signal: currentStreamController.signal
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');

                for (let i = 0; i < lines.length - 1; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    try {
                        const data = JSON.parse(line.replace(/^data: /, ''));
                        const delta = data.choices[0].delta.content || '';

                        if (delta.includes('<think>')) {
                            isThinking = true;
                            thinkingContainer.style.display = 'block';
                        }
                        if (isThinking) {
                            if (delta.includes('</think>')) {
                                isThinking = false;
                                const cleanContent = delta.replace(/<\/?think>/g, '');
                                thinkingContainer.innerHTML += cleanContent;
                                thinkingContainer.innerHTML = marked.parse(thinkingContainer.innerHTML);
                                continue;
                            }
                            thinkingContainer.innerHTML += delta.replace(/<\/?think>/g, '');
                            scrollToBottom();
                            continue;
                        }

                        fullResponse += delta;
                        answerContainer.innerHTML = marked.parse(fullResponse);
                        scrollToBottom();

                    } catch (e) {
                        console.error('解析流式数据错误:', e, '原始数据:', line);
                    }
                }
                buffer = lines[lines.length - 1];
            }

            addMessageToHistory({ role: 'assistant', content: fullResponse });
            saveHistory();

            if (window.MathJax) {
                MathJax.typesetPromise([answerContainer]).catch(err => console.error('MathJax渲染错误:', err));
            }

        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('请求被用户中止');
            } else {
                console.error('请求失败:', error);
                addMessage(`请求失败: ${error.message}`, false);
            }
        } finally {
            disableInput(false);
            isGenerating = false;
            currentStreamController = null;
        }
    }

    function disableInput(disabled) {
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const stopButton = document.getElementById('stopButton');
        userInput.disabled = disabled;
        sendButton.disabled = disabled;
        stopButton.disabled = !disabled;
        if (!disabled) userInput.focus();
    }

    function createThinkingContainer() {
        const container = document.getElementById('chatContainer');
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'thinking-stream';
        thinkingDiv.style.display = 'none';
        container.appendChild(thinkingDiv);
        return thinkingDiv;
    }

    function createAnswerContainer() {
        const container = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message';
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        messageDiv.appendChild(bubble);
        container.appendChild(messageDiv);
        return bubble;
    }

    function addMessageToHistory(message) {
        chatHistory.push(message);
        if (chatHistory.length > 50) chatHistory.shift();
    }

    function saveHistory() {
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    }

    function loadHistory() {
        const saved = localStorage.getItem('chatHistory');
        if (saved) chatHistory = JSON.parse(saved);
    }

    window.clearHistory = function() { // 暴露到全局
        localStorage.removeItem('chatHistory');
        chatHistory = [];
        renderHistory();
    }

    window.exportHistory = function() { // 暴露到全局
        const blob = new Blob([JSON.stringify(chatHistory, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat_history_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function renderHistory() {
        const container = document.getElementById('chatContainer');
        container.innerHTML = '';
        const promises = [];
        chatHistory.forEach(msg => {
            const bubble = addMessage(msg.content, msg.role === 'user');
            if (msg.role !== 'user' && window.MathJax) {
                promises.push(MathJax.typesetPromise([bubble]));
            }
        });
        Promise.all(promises).then(() => scrollToBottom()).catch(err => console.error("历史记录渲染错误:", err));
    }

    function addMessage(content, isUser) {
        const container = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.innerHTML = marked.parse(content);
        messageDiv.appendChild(bubble);
        container.appendChild(messageDiv);
        scrollToBottom();
        return bubble; // 返回bubble用于MathJax渲染
    }

    function scrollToBottom() {
        const container = document.getElementById('chatContainer');
        container.scrollTop = container.scrollHeight;
    }

    window.toggleChat = function() { // 暴露到全局
        const wrapper = document.getElementById("chatWrapper");
        const toggleBtn = wrapper.querySelector(".chat-toggle");
        const footer = wrapper.querySelector(".chat-footer");
        wrapper.classList.toggle("collapsed");
        if (wrapper.classList.contains("collapsed")) {
            toggleBtn.textContent = "▲";
            footer.style.display = "none";
        } else {
            toggleBtn.textContent = "▼";
            footer.style.display = "block";
        }
    }

    // 将原来全局的onclick函数也暴露出来
    window.toggleAnswer = toggleAnswer;
});
</script>
{% endblock %}
